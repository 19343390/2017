

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-88382509-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Network analysis in Python &mdash; Geo-Python - AutoGIS  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Geo-Python - AutoGIS  documentation" href="../../index.html"/>
        <link rel="next" title="Exercise 7" href="ex-7.html"/>
        <link rel="prev" title="Retrieving OpenStreetMap data" href="retrieve-osm-data.html"/>
    <link href="../../_static/geo-python.css" rel="stylesheet" type="text/css">
     


  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Geo-Python - AutoGIS
          

          
            
            <img src="../../_static/logo_hy_geo_135.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                2017
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Course information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../course-info/course-info.html">General info</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../course-info/Installing_Anacondas_GIS.html">Installing Python + GIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../course-info/License-terms.html">License and terms of usage</a></li>
</ul>
<p class="caption"><span class="caption-text">Lesson 1</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../L1/Intro-Python-GIS.html">Introduction to Python GIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L1/overview.html">Lesson overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L1/lecture.html">Lecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L1/Geometric-Objects.html">Geometric Objects - Spatial Data Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L1/ex-1.html">Exercise 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L1/exercise-1-hints.html">Exercise 1 hints</a></li>
</ul>
<p class="caption"><span class="caption-text">Lesson 2</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../L2/overview.html">Lesson 2 Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L2/lecture.html">Lecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L2/geopandas-basics.html">Introduction to Geopandas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L2/projections.html">Map projections</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L2/ex-2.html">Exercise 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L2/exercise-2-hints.html">Exercise 2 hints</a></li>
</ul>
<p class="caption"><span class="caption-text">Lesson 3</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../L3/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L3/lecture.html">Lecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L3/geocoding.html">Geocoding</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L3/point-in-polygon.html">Point in Polygon &amp; Intersect</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L3/spatial-join.html">Spatial join</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L3/nearest-neighbour.html">Nearest Neighbour Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L3/ex-3.html">Exercise 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L3/exercise-3-hints.html">Exercise 3 hints</a></li>
</ul>
<p class="caption"><span class="caption-text">Lesson 4</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../L4/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L4/lecture.html">Lecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L4/reclassify.html">Data reclassification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L4/geometric-operations.html">Geometric operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L4/ex-4.html">Exercise 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L4/exercise-4-hints.html">Exercise 4 hints</a></li>
</ul>
<p class="caption"><span class="caption-text">Lesson 5</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../L5/overview.html">Lesson 5 Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L5/lecture.html">Lecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L5/static-maps.html">Static maps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L5/interactive-map-bokeh.html">Interactive maps with Bokeh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L5/advanced-bokeh.html">Advanced plotting with Bokeh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L5/interactive-map-folium.html">Interactive maps on Leaflet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L5/share-on-github.html">Sharing interactive plots on GitHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L5/ex-5.html">Exercise 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L5/exercise-5-hints.html">Exercise 5 hints</a></li>
</ul>
<p class="caption"><span class="caption-text">Lesson 6</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../L6/01-overview.html">Lesson 6 Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L6/lecture.html">Lecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L6/02-pyqgis.html">Python in QGIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L6/03-processing-toolbox.html">The QGIS Processing Toolbox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L6/04-processing-script.html">Processing toolbox scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L6/04-processing-script.html#run-the-script">Run the script</a></li>
<li class="toctree-l1"><a class="reference internal" href="../L6/ex-6.html">Exercise 6</a></li>
</ul>
<p class="caption"><span class="caption-text">Lesson 7</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture.html">Lecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="retrieve-osm-data.html">Retrieving OpenStreetMap data</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Network analysis in Python</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#analyzing-the-network-properties">Analyzing the network properties</a></li>
<li class="toctree-l2"><a class="reference internal" href="#shortest-path-analysis">Shortest path analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="#saving-shortest-paths-to-disk">Saving shortest paths to disk</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ex-7.html">Exercise 7</a></li>
<li class="toctree-l1"><a class="reference internal" href="exercise-7-hints.html">Exercise 7 hints</a></li>
</ul>
<p class="caption"><span class="caption-text">Final Assignment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../FA/final-assignment.html">Final assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FA/fa-hints.html">Final Assignment hints</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Geo-Python - AutoGIS</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>Network analysis in Python</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/Automating-GIS-processes/2017/blob/master/source/lessons/L7/network-analysis.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="network-analysis-in-python">
<h1>Network analysis in Python<a class="headerlink" href="#network-analysis-in-python" title="Permalink to this headline">¶</a></h1>
<p>Finding a shortest path using a specific street network is a common GIS problem that has many practical
applications. For example navigators are one of those &#8220;every-day&#8221; applications where <strong>routing</strong> using specific algorithms is used
to find the optimal route between two (or multiple) points.</p>
<p>It is also possible to perform network analysis such as tranposrtation routing in Python.
<a class="reference external" href="https://networkx.github.io/documentation/stable/">Networkx</a> is a Python module that provides
a lot tools that can be used to analyze networks on various different ways. It also contains algorithms
such as <a class="reference external" href="https://networkx.github.io/documentation/networkx-1.10/reference/generated/networkx.algorithms.shortest_paths.weighted.single_source_dijkstra.html#networkx.algorithms.shortest_paths.weighted.single_source_dijkstra">Dijkstras algorithm</a> or
<a class="reference external" href="https://networkx.github.io/documentation/networkx-1.10/reference/generated/networkx.algorithms.shortest_paths.astar.astar_path.html#networkx.algorithms.shortest_paths.astar.astar_path">A*</a> algoritm that are commonly used to find shortest paths along transportation network.</p>
<p>To be able to conduct network analysis, it is, of course, necessary to have a network that is used for the analyses.
<a class="reference external" href="https://github.com/gboeing/osmnx">Osmnx</a> package that we just explored in previous tutorial, makes it really easy to
retrieve routable networks from OpenStreetMap with different transport modes (walking, cycling and driving). Osmnx also
combines some functionalities from <code class="docutils literal"><span class="pre">networkx</span></code> module to make it straightforward to conduct routing along OpenStreetMap data.</p>
<p>Next we will test the routing functionalities of osmnx by finding a shortest path between two points based on drivable roads.</p>
<p>Let&#8217;s first download the OSM data from Kamppi but this time include only such street segments that are walkable.
In omsnx it is possible to retrieve only such streets that are drivable by specifying <code class="docutils literal"><span class="pre">'drive'</span></code> into <code class="docutils literal"><span class="pre">network_type</span></code> parameter that can be used to
specify what kind of streets are retrieved from OpenStreetMap (other possibilities are <code class="docutils literal"><span class="pre">walk</span></code> and <code class="docutils literal"><span class="pre">bike</span></code>).</p>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [1]: </span><span class="kn">import</span> <span class="nn">osmnx</span> <span class="kn">as</span> <span class="nn">ox</span>

<span class="gp">In [2]: </span><span class="kn">import</span> <span class="nn">networkx</span> <span class="kn">as</span> <span class="nn">nx</span>

<span class="gp">In [3]: </span><span class="kn">import</span> <span class="nn">geopandas</span> <span class="kn">as</span> <span class="nn">gpd</span>

<span class="gp">In [4]: </span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="gp">In [5]: </span><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>

<span class="gp">In [6]: </span><span class="n">place_name</span> <span class="o">=</span> <span class="s2">&quot;Kamppi, Helsinki, Finland&quot;</span>

<span class="gp">In [7]: </span><span class="n">graph</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">graph_from_place</span><span class="p">(</span><span class="n">place_name</span><span class="p">,</span> <span class="n">network_type</span><span class="o">=</span><span class="s1">&#39;drive&#39;</span><span class="p">)</span>

<span class="gp">In [8]: </span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">plot_graph</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/street_network.png"><img alt="../../_images/street_network.png" src="../../_images/street_network.png" style="width: 7in;" /></a>
<p>Okey so now we have retrieved only such streets where it is possible to drive with a car. Let&#8217;s confirm
this by taking a look at the attributes of the street network. Easiest way to do this is to convert the
graph (nodes and edges) into GeoDataFrames.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [9]: </span><span class="n">edges</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">graph_to_gdfs</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">edges</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li>Let&#8217;s check what columns do we have in our data</li>
</ul>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [10]: </span><span class="n">edges</span><span class="o">.</span><span class="n">columns</span>
<span class="gh">Out[10]: </span><span class="go"></span>
<span class="go">Index([&#39;bridge&#39;, &#39;geometry&#39;, &#39;highway&#39;, &#39;key&#39;, &#39;lanes&#39;, &#39;length&#39;, &#39;maxspeed&#39;,</span>
<span class="go">       &#39;name&#39;, &#39;oneway&#39;, &#39;osmid&#39;, &#39;u&#39;, &#39;v&#39;],</span>
<span class="go">      dtype=&#39;object&#39;)</span>
</pre></div>
</div>
<p>Okey, so we have quite many columns in our GeoDataFrame. Most of the columns are fairly self-exploratory but the following table describes all of them.</p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="31%" />
<col width="19%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Column</th>
<th class="head">Description</th>
<th class="head">Data type</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><a class="reference external" href="http://wiki.openstreetmap.org/wiki/Key:bridge">bridge</a></td>
<td>Bridge feature</td>
<td>boolean</td>
</tr>
<tr class="row-odd"><td>geometry</td>
<td>Geometry of the feature</td>
<td>Shapely.geometry</td>
</tr>
<tr class="row-even"><td><a class="reference external" href="http://wiki.openstreetmap.org/wiki/Key:highway">highway</a></td>
<td>Tag for roads, paths (road type)</td>
<td>str (list if multiple)</td>
</tr>
<tr class="row-odd"><td><a class="reference external" href="http://wiki.openstreetmap.org/wiki/Key:lanes">lanes</a></td>
<td>Number of lanes</td>
<td>int (or nan)</td>
</tr>
<tr class="row-even"><td><a class="reference external" href="http://wiki.openstreetmap.org/wiki/Key:length">lenght</a></td>
<td>The length of a feature in meters</td>
<td>float</td>
</tr>
<tr class="row-odd"><td><a class="reference external" href="http://wiki.openstreetmap.org/wiki/Key:maxspeed">maxspeed</a></td>
<td>maximum legal speed limit</td>
<td>int (list if multiple)</td>
</tr>
<tr class="row-even"><td><a class="reference external" href="http://wiki.openstreetmap.org/wiki/Key:name">name</a></td>
<td>Name of the (street) element</td>
<td>str (or nan)</td>
</tr>
<tr class="row-odd"><td><a class="reference external" href="http://wiki.openstreetmap.org/wiki/Key:oneway">oneway</a></td>
<td>Street is usable only in one direction</td>
<td>boolean</td>
</tr>
<tr class="row-even"><td><a class="reference external" href="http://wiki.openstreetmap.org/wiki/Node">osmid</a></td>
<td>Unique node ids of the element</td>
<td>list</td>
</tr>
<tr class="row-odd"><td><a class="reference external" href="http://ow.ly/bV8n30h7Ufm">u</a></td>
<td>The first node of networkx edge tuple</td>
<td>int</td>
</tr>
<tr class="row-even"><td><a class="reference external" href="http://ow.ly/bV8n30h7Ufm">v</a></td>
<td>The last node of networkx edge tuple</td>
<td>int</td>
</tr>
</tbody>
</table>
<p>Most of the attributes comes directly from the OpenStreetMap, however, columns <code class="docutils literal"><span class="pre">u</span></code> and <code class="docutils literal"><span class="pre">v</span></code> are networkx specific ids.</p>
<ul class="simple">
<li>Let&#8217;s take a look what kind of features we have in <code class="docutils literal"><span class="pre">highway</span></code> column.</li>
</ul>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [11]: </span><span class="n">edges</span><span class="p">[</span><span class="s1">&#39;highway&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="gh">Out[11]: </span><span class="go"></span>
<span class="go">residential      110</span>
<span class="go">tertiary          82</span>
<span class="go">primary           25</span>
<span class="go">secondary         18</span>
<span class="go">unclassified      11</span>
<span class="go">living_street      4</span>
<span class="go">primary_link       1</span>
<span class="go">Name: highway, dtype: int64</span>

<span class="gp">In [12]: </span><span class="k">print</span><span class="p">(</span><span class="s2">&quot;Coordinate system:&quot;</span><span class="p">,</span> <span class="n">edges</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
<span class="go">                                                                                                                                                                                         Coordinate system: {&#39;init&#39;: &#39;epsg:4326&#39;}</span>
</pre></div>
</div>
<p>Okey, now we can confirm that as a result our street network indeed only contains such streets where it is allowed to drive with a car as there are no e.g. cycleways of footways included in the data.
We can also see that the CRS of the GeoDataFrame seems to be WGS84 (i.e. epsg: 4326).</p>
<p>Let&#8217;s continue and find the shortest path between two points based on the distance. As the data is in WGS84 format, we might first want to reproject our data into metric system so that our map looks better.
Luckily there is a handy function in osmnx called <code class="docutils literal"><span class="pre">project_graph()</span></code> to project the graph data in UTM format.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [13]: </span><span class="n">graph_proj</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">project_graph</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>

<span class="gp">In [14]: </span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">plot_graph</span><span class="p">(</span><span class="n">graph_proj</span><span class="p">)</span>

<span class="gp">In [15]: </span><span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/proj_graph.png"><img alt="../../_images/proj_graph.png" src="../../_images/proj_graph.png" style="width: 5in;" /></a>
<ul class="simple">
<li>Let&#8217;s see how our data looks like now.</li>
</ul>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [16]: </span><span class="n">nodes_proj</span><span class="p">,</span> <span class="n">edges_proj</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">graph_to_gdfs</span><span class="p">(</span><span class="n">graph_proj</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">edges</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="gp">In [17]: </span><span class="k">print</span><span class="p">(</span><span class="s2">&quot;Coordinate system:&quot;</span><span class="p">,</span> <span class="n">edges_proj</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
<span class="go">Coordinate system: {&#39;datum&#39;: &#39;NAD83&#39;, &#39;ellps&#39;: &#39;GRS80&#39;, &#39;proj&#39;: &#39;utm&#39;, &#39;zone&#39;: 35, &#39;units&#39;: &#39;m&#39;}</span>

<span class="gp">In [18]: </span><span class="n">edges_proj</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="go">                                                                                                 Out[18]: </span>
<span class="go">  bridge                                           geometry   highway  key  \</span>
<span class="go">0    NaN  LINESTRING (384627.5455369067 6671580.41232014...   primary    0   </span>
<span class="go">1    NaN  LINESTRING (384626.0520768312 6671454.14883848...   primary    0   </span>
<span class="go">2    NaN  LINESTRING (384644.4188576039 6671561.40362007...   primary    0   </span>
<span class="go">3    NaN  LINESTRING (384644.4188576039 6671561.40362007...   primary    0   </span>
<span class="go">4    NaN  LINESTRING (385515.6177346901 6671500.06500373...  tertiary    0   </span>

<span class="go">  lanes      length  maxspeed            name  oneway  \</span>
<span class="go">0     2   40.546678        40  Mechelininkatu    True   </span>
<span class="go">1     2   16.621387        40  Mechelininkatu    True   </span>
<span class="go">2     2   29.174418        40             NaN    True   </span>
<span class="go">3     2  242.269892        40  Mechelininkatu    True   </span>
<span class="go">4   NaN  139.185362  [30, 40]   Fredrikinkatu    True   </span>

<span class="go">                                               osmid         u           v  </span>
<span class="go">0                               [23856784, 31503767]  25216594  1372425714  </span>
<span class="go">1                               [29977177, 30470347]  25238874  1372425713  </span>
<span class="go">2                               [372440330, 8135861]  25238944    25216594  </span>
<span class="go">3                     [25514547, 30288797, 30288799]  25238944   319896278  </span>
<span class="go">4  [30568275, 36729015, 316590744, 316590745, 316...  25291537    25291591  </span>
</pre></div>
</div>
<p>Okey, as we can see from the CRS the data is now in <a class="reference external" href="https://en.wikipedia.org/wiki/Universal_Transverse_Mercator_coordinate_system">UTM projection</a> using zone 35 which is the one used for Finland,
and indeed the orientation of the map and the geometry values also confirm this.</p>
<div class="section" id="analyzing-the-network-properties">
<h2>Analyzing the network properties<a class="headerlink" href="#analyzing-the-network-properties" title="Permalink to this headline">¶</a></h2>
<p>Now as we have seen some of the basic functionalities of osmnx such as downloading the data and converting data from graph to GeoDataFrame,
we can take a look some of the analytical features of omsnx. Osmnx includes many useful functionalities to
extract information about the network.</p>
<ul class="simple">
<li>To calculate some of the basic street network measures we can use <code class="docutils literal"><span class="pre">basic_stats()</span></code> function of osmnx</li>
</ul>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [19]: </span><span class="n">stats</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">basic_stats</span><span class="p">(</span><span class="n">graph_proj</span><span class="p">)</span>

<span class="gp">In [20]: </span><span class="n">stats</span>
<span class="gh">Out[20]: </span><span class="go"></span>
<span class="go">{&#39;circuity_avg&#39;: 1.2765042570918806e-05,</span>
<span class="go"> &#39;clean_intersection_count&#39;: None,</span>
<span class="go"> &#39;clean_intersection_density_km&#39;: None,</span>
<span class="go"> &#39;edge_density_km&#39;: None,</span>
<span class="go"> &#39;edge_length_avg&#39;: 78.835341593345689,</span>
<span class="go"> &#39;edge_length_total&#39;: 19787.670739929767,</span>
<span class="go"> &#39;intersection_count&#39;: 115,</span>
<span class="go"> &#39;intersection_density_km&#39;: None,</span>
<span class="go"> &#39;k_avg&#39;: 4.08130081300813,</span>
<span class="go"> &#39;m&#39;: 251,</span>
<span class="go"> &#39;n&#39;: 123,</span>
<span class="go"> &#39;node_density_km&#39;: None,</span>
<span class="go"> &#39;self_loop_proportion&#39;: 0.0,</span>
<span class="go"> &#39;street_density_km&#39;: None,</span>
<span class="go"> &#39;street_length_avg&#39;: 75.031938093148469,</span>
<span class="go"> &#39;street_length_total&#39;: 13505.748856766724,</span>
<span class="go"> &#39;street_segments_count&#39;: 180,</span>
<span class="go"> &#39;streets_per_node_avg&#39;: 3.1951219512195124,</span>
<span class="go"> &#39;streets_per_node_counts&#39;: {0: 0, 1: 8, 2: 1, 3: 73, 4: 41},</span>
<span class="go"> &#39;streets_per_node_proportion&#39;: {0: 0.0,</span>
<span class="go">  1: 0.06504065040650407,</span>
<span class="go">  2: 0.008130081300813009,</span>
<span class="go">  3: 0.5934959349593496,</span>
<span class="go">  4: 0.3333333333333333}}</span>
</pre></div>
</div>
<p>To be able to extract the more advanced statistics (and some of the missing ones above) from the street network, it is required to have information
about the coverage area of the network. Let&#8217;s calculate the area of the <a class="reference external" href="https://en.wikipedia.org/wiki/Convex_hull">convex hull</a> of the street network and see what we can get.
As certain statistics are produced separately for each node, they produce a lot of output. Let&#8217;s merge both stats and put them into Pandas Series to keep things mroe compact.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [21]: </span><span class="n">area</span> <span class="o">=</span> <span class="n">edges_proj</span><span class="o">.</span><span class="n">unary_union</span><span class="o">.</span><span class="n">convex_hull</span><span class="o">.</span><span class="n">area</span>

<span class="gp">In [22]: </span><span class="n">stats</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">basic_stats</span><span class="p">(</span><span class="n">graph_proj</span><span class="p">,</span> <span class="n">area</span><span class="o">=</span><span class="n">area</span><span class="p">)</span>

<span class="gp">In [23]: </span><span class="n">extended_stats</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">extended_stats</span><span class="p">(</span><span class="n">graph_proj</span><span class="p">,</span> <span class="n">ecc</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">cc</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="gp">In [24]: </span><span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">extended_stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="gp">   ....: </span>    <span class="n">stats</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<span class="gp">   ....: </span>

<span class="gp">In [25]: </span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
<span class="gh">Out[25]: </span><span class="go"></span>
<span class="go">avg_neighbor_degree                    {25216594: 2.0, 25238874: 2.0, 25238944: 1.0, ...</span>
<span class="go">avg_neighbor_degree_avg                                                          2.16599</span>
<span class="go">avg_weighted_neighbor_degree           {25216594: 0.04932586528128221, 25238874: 0.12...</span>
<span class="go">avg_weighted_neighbor_degree_avg                                               0.0773233</span>
<span class="go">betweenness_centrality                 {25216594: 0.03962877658853814, 25238874: 0.06...</span>
<span class="go">betweenness_centrality_avg                                                     0.0679948</span>
<span class="go">center                                                                      [1372376937]</span>
<span class="go">circuity_avg                                                                  1.2765e-05</span>
<span class="go">clean_intersection_count                                                            None</span>
<span class="go">clean_intersection_density_km                                                       None</span>
<span class="go">closeness_centrality                   {25216594: 0.000856552987043, 25238874: 0.0009...</span>
<span class="go">closeness_centrality_avg                                                      0.00141561</span>
<span class="go">clustering_coefficient                 {25216594: 0, 25238874: 0, 25238944: 0, 252915...</span>
<span class="go">clustering_coefficient_avg                                                     0.0867209</span>
<span class="go">clustering_coefficient_weighted        {25216594: 0, 25238874: 0, 25238944: 0, 252915...</span>
<span class="go">clustering_coefficient_weighted_avg                                            0.0157325</span>
<span class="go">degree_centrality                      {25216594: 0.02459016393442623, 25238874: 0.02...</span>
<span class="go">degree_centrality_avg                                                          0.0334533</span>
<span class="go">diameter                                                                         2139.02</span>
<span class="go">eccentricity                           {25216594: 1900.88375336, 25238874: 1774.60317...</span>
<span class="go">edge_density_km                                                                  24654.7</span>
<span class="go">edge_length_avg                                                                  78.8353</span>
<span class="go">edge_length_total                                                                19787.7</span>
<span class="go">intersection_count                                                                   115</span>
<span class="go">intersection_density_km                                                          143.286</span>
<span class="go">k_avg                                                                             4.0813</span>
<span class="go">m                                                                                    251</span>
<span class="go">n                                                                                    123</span>
<span class="go">node_density_km                                                                  153.253</span>
<span class="go">pagerank                               {25216594: 0.00906630275862, 25238874: 0.00840...</span>
<span class="go">pagerank_max                                                                   0.0242956</span>
<span class="go">pagerank_max_node                                                               25416262</span>
<span class="go">pagerank_min                                                                  0.00140976</span>
<span class="go">pagerank_min_node                                                             1861896879</span>
<span class="go">periphery                                                                    [319896278]</span>
<span class="go">radius                                                                           993.275</span>
<span class="go">self_loop_proportion                                                                   0</span>
<span class="go">street_density_km                                                                16827.7</span>
<span class="go">street_length_avg                                                                75.0319</span>
<span class="go">street_length_total                                                              13505.7</span>
<span class="go">street_segments_count                                                                180</span>
<span class="go">streets_per_node_avg                                                             3.19512</span>
<span class="go">streets_per_node_counts                                 {0: 0, 1: 8, 2: 1, 3: 73, 4: 41}</span>
<span class="go">streets_per_node_proportion            {0: 0.0, 1: 0.06504065040650407, 2: 0.00813008...</span>
<span class="go">dtype: object</span>
</pre></div>
</div>
<p>Okey, now we have a <strong>LOT</strong> of information about our street network that can be used to understand its structure.
We can for example see that the average node density in our network is <code class="docutils literal"><span class="pre">153</span> <span class="pre">nodes/km</span></code> and that the total edge length of our network is <code class="docutils literal"><span class="pre">19787.7</span> <span class="pre">meters</span></code>.
Furthermore, we can see that the <a class="reference external" href="https://en.wikipedia.org/wiki/Centrality">degree centrality</a> of our network is
on average <code class="docutils literal"><span class="pre">0.0334533</span></code>. Degree is a simple centrality measure that counts how many neighbors a node has (here a fraction of nodes it is connected to).
Another interesting measure is the <a class="reference external" href="https://en.wikipedia.org/wiki/PageRank">PageRank</a> that measures the importance of specific node
in the graph. Here we can see that the most important node in our graph seem to a node with osmid <code class="docutils literal"><span class="pre">25416262</span></code>.
PageRank was the algorithm that Google first developed (Larry Page &amp; Sergei Brin) to order the search engine results and became famous for.</p>
<p>You can read the <a class="reference external" href="https://en.wikipedia.org/wiki/Centrality">Wikipedia article about different centrality measures</a> if you are interested what the other centrality measures mean.</p>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">There are a lot of good examples of different ways to analyze the network properties with osmnx.
Take a look at the <a class="reference external" href="https://github.com/gboeing/osmnx-examples">Osmnx examples repository</a>.</p>
</div>
</div>
<div class="section" id="shortest-path-analysis">
<h2>Shortest path analysis<a class="headerlink" href="#shortest-path-analysis" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s now calculate the shortest path between two points. First we need to specify the source and target locations
for our route. Let&#8217;s use the centroid of our network as the source location and the furthest point in East in our network as the target location.</p>
<p>Let&#8217;s first determine the centroid of our network. We can take advantage of the <code class="docutils literal"><span class="pre">bounds</span></code> attribute to find out the bounding boxes for each feature in our data. We then make a unary union of those features and make a bounding box geometry out of those values that enables us to determine the centroid of our data.</p>
<ul class="simple">
<li>This is what the bounds command gives us.</li>
</ul>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [26]: </span><span class="n">edges_proj</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="gh">Out[26]: </span><span class="go"></span>
<span class="go">            minx          miny           maxx          maxy</span>
<span class="go">0  384624.169951  6.671540e+06  384627.545537  6.671580e+06</span>
<span class="go">1  384626.052077  6.671438e+06  384627.546229  6.671454e+06</span>
<span class="go">2  384627.545537  6.671561e+06  384644.418858  6.671580e+06</span>
<span class="go">3  384639.622763  6.671561e+06  384649.706783  6.671803e+06</span>
<span class="go">4  385439.278555  6.671500e+06  385515.617735  6.671617e+06</span>
</pre></div>
</div>
<p>Okey so it is a DataFrame of minimum and maximum x- and y coordinates.</p>
<ul class="simple">
<li>Let&#8217;s create a bounding box out of those.</li>
</ul>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [27]: </span><span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">box</span>

<span class="gp">In [28]: </span><span class="n">bbox</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">edges_proj</span><span class="o">.</span><span class="n">unary_union</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

<span class="gp">In [29]: </span><span class="k">print</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span>
<span class="go">POLYGON ((385779.4656930579 6671142.734205207, 385779.4656930579 6672267.056878939, 384624.1699512366 6672267.056878939, 384624.1699512366 6671142.734205207, 385779.4656930579 6671142.734205207))</span>
</pre></div>
</div>
<p>Okey so as a result we seem to have a Polygon, but what actually happened here? First of all, we took the Geometries from our <code class="docutils literal"><span class="pre">edges_proj</span></code> GeoDataFrame (123 features) and made a unary union of those features (as a result we have a MultiLineString).
From the MultiLineString we can retrieve the maximum and minimum x and y coordinates of the geometry using the <code class="docutils literal"><span class="pre">bounds</span></code> attribute.
The bounds command returns a tuple of four coordinates (minx, miny, maxx, maxy). As a final step we feed those coordinates into box() function that creates a shapely.Polygon object out of those coordinates.
The * -character is used to unpack the values from the tuple (<a class="reference external" href="https://docs.python.org/3/tutorial/controlflow.html#unpacking-argument-lists">see details</a>)</p>
<ul class="simple">
<li>Now we can extract the centroid of our bounding box as the source location.</li>
</ul>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [30]: </span><span class="n">orig_point</span> <span class="o">=</span> <span class="n">bbox</span><span class="o">.</span><span class="n">centroid</span>

<span class="gp">In [31]: </span><span class="k">print</span><span class="p">(</span><span class="n">orig_point</span><span class="p">)</span>
<span class="go">POINT (385201.8178221472 6671704.895542073)</span>
</pre></div>
</div>
<ul class="simple">
<li>Let&#8217;s now find the easternmost node in our street network. We can do this by calculating the x coordinates and finding out which node has the largest x-coordinate value. Let&#8217;s ensure that the values are floats.</li>
</ul>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [32]: </span><span class="n">nodes_proj</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes_proj</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

<span class="gp">In [33]: </span><span class="n">maxx</span> <span class="o">=</span> <span class="n">nodes_proj</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
<ul class="simple">
<li>Let&#8217;s retrieve the target Point having the largest x-coordinate. We can do this by using the .loc function of Pandas that we have used already many times in earlier tutorials.</li>
</ul>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [34]: </span><span class="n">target_loc</span> <span class="o">=</span> <span class="n">nodes_proj</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">nodes_proj</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">maxx</span><span class="p">,</span> <span class="p">:]</span>

<span class="gp">In [35]: </span><span class="k">print</span><span class="p">(</span><span class="n">target_loc</span><span class="p">)</span>
<span class="go">         highway      lat      lon     osmid              x            y  \</span>
<span class="go">25291564     NaN  60.1659  24.9417  25291564  385779.465693  6.67167e+06   </span>

<span class="go">                                             geometry  </span>
<span class="go">25291564  POINT (385779.4656930579 6671672.812631538)  </span>
</pre></div>
</div>
<p>Okey now we can see that as a result we have a GeoDataFrame with only one node and the information associated with it.</p>
<ul class="simple">
<li>Let&#8217;s extract the Point geometry from the data.</li>
</ul>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [36]: </span><span class="n">target_point</span> <span class="o">=</span> <span class="n">target_loc</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="gp">In [37]: </span><span class="k">print</span><span class="p">(</span><span class="n">target_point</span><span class="p">)</span>
<span class="go">POINT (385779.4656930579 6671672.812631538)</span>
</pre></div>
</div>
<ul class="simple">
<li>Let&#8217;s now find the nearest graph nodes (and their node-ids) to these points. For osmnx we need to parse the coordinates of the Point as coordinate-tuple with Latitude, Longitude coordinates.</li>
</ul>
<p>As our data is now projected to UTM projection, we need to specify with <code class="docutils literal"><span class="pre">method</span></code> parameter that the function uses
&#8216;euclidean&#8217; distances to calculate the distance from the point to the closest node.
This becomes important if you want to know the actual distance between the Point and the closest node which you can retrieve by specifying parameter <code class="docutils literal"><span class="pre">return_dist=True</span></code>.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [38]: </span><span class="n">orig_xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">orig_point</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">orig_point</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

<span class="gp">In [39]: </span><span class="n">target_xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_point</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">target_point</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

<span class="gp">In [40]: </span><span class="n">orig_node</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">get_nearest_node</span><span class="p">(</span><span class="n">graph_proj</span><span class="p">,</span> <span class="n">orig_xy</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)</span>

<span class="gp">In [41]: </span><span class="n">target_node</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">get_nearest_node</span><span class="p">(</span><span class="n">graph_proj</span><span class="p">,</span> <span class="n">target_xy</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)</span>

<span class="gp">In [42]: </span><span class="n">o_closest</span> <span class="o">=</span> <span class="n">nodes_proj</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">orig_node</span><span class="p">]</span>

<span class="gp">In [43]: </span><span class="n">t_closest</span> <span class="o">=</span> <span class="n">nodes_proj</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">target_node</span><span class="p">]</span>

<span class="gp">In [44]: </span><span class="k">print</span><span class="p">(</span><span class="n">orig_node</span><span class="p">)</span>
<span class="go">1372441183</span>

<span class="gp">In [45]: </span><span class="k">print</span><span class="p">(</span><span class="n">target_node</span><span class="p">)</span>
<span class="go">           25291564</span>
</pre></div>
</div>
<ul class="simple">
<li>Let&#8217;s make a GeoDataFrame out of these series</li>
</ul>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [46]: </span><span class="n">od_nodes</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">([</span><span class="n">o_closest</span><span class="p">,</span> <span class="n">t_closest</span><span class="p">],</span> <span class="n">geometry</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">nodes_proj</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
</pre></div>
</div>
<p>Okey, as a result we got now the closest node-ids of our origin and target locations.</p>
<ul class="simple">
<li>Now we are ready to do the routing and find the shortest path between the origin and target locations</li>
</ul>
<p>by using the <code class="docutils literal"><span class="pre">shortest_path()</span></code> <a class="reference external" href="https://networkx.github.io/documentation/networkx-1.10/reference/generated/networkx.algorithms.shortest_paths.generic.shortest_path.html">function</a> of networkx.
With <code class="docutils literal"><span class="pre">weight</span></code> -parameter we can specify that <code class="docutils literal"><span class="pre">'length'</span></code> attribute should be used as the cost impedance in the routing.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [47]: </span><span class="n">route</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="n">G</span><span class="o">=</span><span class="n">graph_proj</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">orig_node</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target_node</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;length&#39;</span><span class="p">)</span>

<span class="gp">In [48]: </span><span class="k">print</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>
<span class="go">[1372441183, 1372441170, 60170471, 1377211668, 1377211666, 25291565, 25291564]</span>
</pre></div>
</div>
<p>Okey, as a result we get a list of all the nodes that are along the shortest path. We could extract the locations of those nodes from the <code class="docutils literal"><span class="pre">nodes_proj</span></code> GeoDataFrame and create a LineString presentation of the points,
but luckily, osmnx can do that for us and we can plot shortest path by using <code class="docutils literal"><span class="pre">plot_graph_route()</span></code> function.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [49]: </span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">plot_graph_route</span><span class="p">(</span><span class="n">graph_proj</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="n">origin_point</span><span class="o">=</span><span class="n">orig_xy</span><span class="p">,</span> <span class="n">destination_point</span><span class="o">=</span><span class="n">target_xy</span><span class="p">)</span>

<span class="gp">In [50]: </span><span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/routing.png"><img alt="../../_images/routing.png" src="../../_images/routing.png" style="width: 5in;" /></a>
<p>Awesome! Now we have a the shortest path between our origin and target locations.
Being able to analyze shortest paths between locations can be valuable information for many applications.
Here, we only analyzed the shortest paths based on distance but quite often it is more useful to find the
optimal routes between locations based on the travelled time. Here, for example we could calculate the time that it takes
to cross each road segment by dividing the length of the road segment with the speed limit and calculate the optimal routes by
taking into account the speed limits as well that might alter the result especially on longer trips than here.</p>
</div>
<div class="section" id="saving-shortest-paths-to-disk">
<h2>Saving shortest paths to disk<a class="headerlink" href="#saving-shortest-paths-to-disk" title="Permalink to this headline">¶</a></h2>
<p>Quite often you need to save the route e.g. as a Shapefile.
Hence, let&#8217;s continue still a bit and see how we can make a Shapefile of our route with some information associated with it.</p>
<ul class="simple">
<li>First we need to get the nodes that belong to the shortest path.</li>
</ul>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [51]: </span><span class="n">route_nodes</span> <span class="o">=</span> <span class="n">nodes_proj</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">route</span><span class="p">]</span>

<span class="gp">In [52]: </span><span class="k">print</span><span class="p">(</span><span class="n">route_nodes</span><span class="p">)</span>
<span class="go">                    highway      lat      lon       osmid              x  \</span>
<span class="go">1372441183              NaN  60.1658  24.9312  1372441183  385199.040421   </span>
<span class="go">1372441170              NaN  60.1652   24.932  1372441170  385239.956997   </span>
<span class="go">60170471                NaN  60.1661  24.9345    60170471  385382.590390   </span>
<span class="go">1377211668              NaN  60.1669  24.9368  1377211668  385514.080701   </span>
<span class="go">1377211666              NaN  60.1662  24.9379  1377211666  385570.886276   </span>
<span class="go">25291565    traffic_signals  60.1651  24.9393    25291565  385647.135652   </span>
<span class="go">25291564                NaN  60.1659  24.9417    25291564  385779.465693   </span>

<span class="go">                      y                                     geometry  </span>
<span class="go">1372441183  6.67167e+06  POINT (385199.0404211304 6671671.819689871)  </span>
<span class="go">1372441170  6.67161e+06  POINT (385239.9569968735 6671610.079883121)  </span>
<span class="go">60170471     6.6717e+06  POINT (385382.5903898547 6671704.041333381)  </span>
<span class="go">1377211668  6.67179e+06   POINT (385514.080700958 6671789.786299309)  </span>
<span class="go">1377211666   6.6717e+06  POINT (385570.8862759892 6671702.891562204)  </span>
<span class="go">25291565    6.67159e+06  POINT (385647.1356519004 6671586.226356798)  </span>
<span class="go">25291564    6.67167e+06  POINT (385779.4656930579 6671672.812631538)  </span>
</pre></div>
</div>
<ul class="simple">
<li>Now we can create a LineString out of the Point geometries of the nodes</li>
</ul>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [53]: </span><span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">LineString</span><span class="p">,</span> <span class="n">Point</span>

<span class="gp">In [54]: </span><span class="n">route_line</span> <span class="o">=</span> <span class="n">LineString</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">route_nodes</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>

<span class="gp">In [55]: </span><span class="k">print</span><span class="p">(</span><span class="n">route_line</span><span class="p">)</span>
<span class="go">LINESTRING (385199.0404211304 6671671.819689871, 385239.9569968735 6671610.079883121, 385382.5903898547 6671704.041333381, 385514.080700958 6671789.786299309, 385570.8862759892 6671702.891562204, 385647.1356519004 6671586.226356798, 385779.4656930579 6671672.812631538)</span>
</pre></div>
</div>
<ul class="simple">
<li>Let&#8217;s make a GeoDataFrame having some useful information about our route such as a list of the osmids that are part of the route and the length of the route.</li>
</ul>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [56]: </span><span class="n">route_geom</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">edges_proj</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

<span class="gp">In [57]: </span><span class="n">route_geom</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="gp">In [58]: </span><span class="n">route_geom</span><span class="p">[</span><span class="s1">&#39;osmids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
</pre></div>
</div>
<ul class="simple">
<li>Let&#8217;s add the information: geometry, a list of osmids and the length of the route.</li>
</ul>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [59]: </span><span class="n">route_geom</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">route_line</span>

<span class="gp">In [60]: </span><span class="n">route_geom</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;osmids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">route_nodes</span><span class="p">[</span><span class="s1">&#39;osmid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>

<span class="gp">In [61]: </span><span class="n">route_geom</span><span class="p">[</span><span class="s1">&#39;length_m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">route_geom</span><span class="o">.</span><span class="n">length</span>
</pre></div>
</div>
<p>Now we have a GeoDataFrame that we can save to disk. Let&#8217;s still confirm that everything is okey by plotting our route
on top of our street network, and plot also the origin and target points on top of our map.</p>
<ul class="simple">
<li>Let&#8217;s first prepare a GeoDataFrame for our origin and target points.</li>
</ul>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [62]: </span><span class="n">od_points</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">edges_proj</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

<span class="gp">In [63]: </span><span class="n">od_points</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="gp">In [64]: </span><span class="n">od_points</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="gp">In [65]: </span><span class="n">od_points</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">orig_point</span><span class="p">,</span> <span class="s1">&#39;Origin&#39;</span>

<span class="gp">In [66]: </span><span class="n">od_points</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">target_point</span><span class="p">,</span> <span class="s1">&#39;Target&#39;</span>

<span class="gp">In [67]: </span><span class="n">od_points</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="gh">Out[67]: </span><span class="go"></span>
<span class="go">                                      geometry    type</span>
<span class="go">0  POINT (385201.8178221472 6671704.895542073)  Origin</span>
<span class="go">1  POINT (385779.4656930579 6671672.812631538)  Target</span>
</pre></div>
</div>
<ul class="simple">
<li>Let&#8217;s also get the buildings for our area and plot them as well.</li>
</ul>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [68]: </span><span class="n">buildings</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">buildings_from_place</span><span class="p">(</span><span class="n">place_name</span><span class="p">)</span>

<span class="gp">In [69]: </span><span class="n">buildings_proj</span> <span class="o">=</span> <span class="n">buildings</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">edges_proj</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li>Let&#8217;s now plot the route and the street network elements to verify that everything is as it should.</li>
</ul>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [70]: </span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="gp">In [71]: </span><span class="n">edges_proj</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="go">                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              Out[71]: &lt;matplotlib.axes._subplots.AxesSubplot at 0x2ce1cdb5b38&gt;</span>

<span class="gp">In [72]: </span><span class="n">nodes_proj</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="go">                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Out[72]: &lt;matplotlib.axes._subplots.AxesSubplot at 0x2ce1cdb5b38&gt;</span>

<span class="gp">In [73]: </span><span class="n">buildings_proj</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;khaki&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="go">                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  Out[73]: &lt;matplotlib.axes._subplots.AxesSubplot at 0x2ce1cdb5b38&gt;</span>

<span class="gp">In [74]: </span><span class="n">route_geom</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="go">                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    Out[74]: &lt;matplotlib.axes._subplots.AxesSubplot at 0x2ce1cdb5b38&gt;</span>

<span class="gp">In [75]: </span><span class="n">od_points</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="go">                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      Out[75]: &lt;matplotlib.axes._subplots.AxesSubplot at 0x2ce1cdb5b38&gt;</span>

<span class="gp">In [76]: </span><span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/routing_with_buildings.png"><img alt="../../_images/routing_with_buildings.png" src="../../_images/routing_with_buildings.png" style="width: 6in;" /></a>
<p>Great everything seems to be in order! As you can see, now we have a full
control of all the elements of our map and we can use all the aesthetic
properties that matplotlib provides to modify how our map will look like.
Now we can save to disk all the elements that we want.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="go"># Parse the place name for the output file names (replace spaces with underscores and remove commas)</span>
<span class="gp">In [77]: </span><span class="n">place_name_out</span> <span class="o">=</span> <span class="n">place_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="gp">In [78]: </span><span class="n">streets_out</span> <span class="o">=</span> <span class="s2">r&quot;/home/geo/</span><span class="si">%s</span><span class="s2">_streets.shp&quot;</span> <span class="o">%</span> <span class="n">place_name_out</span>

<span class="gp">In [79]: </span><span class="n">route_out</span> <span class="o">=</span> <span class="s2">r&quot;/home/geo/Route_from_a_to_b_at_</span><span class="si">%s</span><span class="s2">.shp&quot;</span> <span class="o">%</span> <span class="n">place_name_out</span>

<span class="gp">In [80]: </span><span class="n">nodes_out</span> <span class="o">=</span> <span class="s2">r&quot;/home/geo/</span><span class="si">%s</span><span class="s2">_nodes.shp&quot;</span> <span class="o">%</span> <span class="n">place_name_out</span>

<span class="gp">In [81]: </span><span class="n">buildings_out</span> <span class="o">=</span> <span class="s2">r&quot;/home/geo/</span><span class="si">%s</span><span class="s2">_buildings.shp&quot;</span> <span class="o">%</span> <span class="n">place_name_out</span>

<span class="gp">In [82]: </span><span class="n">od_out</span> <span class="o">=</span> <span class="s2">r&quot;/home/geo/</span><span class="si">%s</span><span class="s2">_route_OD_points.shp&quot;</span> <span class="o">%</span> <span class="n">place_name_out</span>
</pre></div>
</div>
<p>As there are certain columns with such data values that Shapefile format does not support (such as <code class="docutils literal"><span class="pre">list</span></code> or <code class="docutils literal"><span class="pre">boolean</span></code>), we need to convert those into strings to be able to export the data to Shapefile.</p>
<ul class="simple">
<li>Columns with invalid values</li>
</ul>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [83]: </span><span class="n">invalid_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lanes&#39;</span><span class="p">,</span> <span class="s1">&#39;maxspeed&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;oneway&#39;</span><span class="p">,</span> <span class="s1">&#39;osmid&#39;</span><span class="p">]</span>
</pre></div>
</div>
<ul class="simple">
<li>Iterate over invalid columns and convert them to string format</li>
</ul>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [84]: </span><span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">invalid_cols</span><span class="p">:</span>
<span class="gp">   ....: </span>    <span class="n">edges_proj</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges_proj</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="gp">   ....: </span>
</pre></div>
</div>
<ul class="simple">
<li>Save the data</li>
</ul>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [85]: </span><span class="n">edges_proj</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">streets_out</span><span class="p">)</span>

<span class="gp">In [86]: </span><span class="n">route_geom</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">route_out</span><span class="p">)</span>

<span class="gp">In [87]: </span><span class="n">nodes_proj</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">nodes_out</span><span class="p">)</span>

<span class="gp">In [88]: </span><span class="n">od_points</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">od_out</span><span class="p">)</span>

<span class="gp">In [89]: </span><span class="n">buildings</span><span class="p">[[</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;addr:street&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">buildings_out</span><span class="p">)</span>
</pre></div>
</div>
<p>Great now we have saved all the data that was used to produce the maps as Shapefiles.</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="ex-7.html" class="btn btn-neutral float-right" title="Exercise 7" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="retrieve-osm-data.html" class="btn btn-neutral" title="Retrieving OpenStreetMap data" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Henrikki Tenkanen.
      Last updated on Dec 16, 2017.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
    <p> <br/> <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br /> </a></p>
     


</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>